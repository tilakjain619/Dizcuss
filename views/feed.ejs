<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/photos/brand/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../assets/photos/brand/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../assets/photos/brand/favicon-16x16.png">
    <link rel="stylesheet" href="../assets/css/home.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/js/all.min.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed | Dizcuss</title>
</head>

<body>
    <%- include('sidebar', { currentPage: 'Feed'}) %>
    <iframe src="../trending.html" class="most-trending-discussion-container" frameborder="0"></iframe>
        <div class="home-container">
            <section id="create-discussion">
                <form id="discussion-form">

                    <label for="content">Add Discussion</label>
                    <textarea id="content" class="content-input" name="content" rows="4" cols="50"
                        placeholder="Ask a question?" required></textarea><br>

                    <button type="submit" class="submit-button">Post</button>
                </form>
            </section>
            <% 
            function formatTimestamp(createdAt) {
                const now = new Date();
                const diffInMilliseconds = now - createdAt;
              
                if (diffInMilliseconds < 60000) {
                  return `${Math.floor(diffInMilliseconds / 1000)} seconds ago`;
                } else if (diffInMilliseconds < 3600000) {
                  return `${Math.floor(diffInMilliseconds / 60000)} minutes ago`;
                } else if (diffInMilliseconds < 86400000) {
                  return `${Math.floor(diffInMilliseconds / 3600000)} hours ago`;
                } else {
                  return `${Math.floor(diffInMilliseconds / 86400000)} days ago`;
                }
              }
  %>            
            <div id="discussions" class="discussion-container">
                <% discussions.forEach(discussion=> { %>
                    <%
                    const createdAt = new Date(discussion.createdAt);
            const formattedTimestamp = formatTimestamp(createdAt); 
            // Get the count of replies for this discussion
            const replyCount = discussion.replies.length;
            %>
            
                    <div class="discussion-card">
                        <a href="/member/<%= discussion.user.username %>" class="user-detail-name">
                            <p class="user-full-name"><%= discussion.user.fullName %></p>
                        <p class="user-name">
                            @<%= discussion.user.username %>
                        </p>
                    </a>
                        <a href="/discussion/<%= discussion._id %>">
                        <p class="discussion-title" data-id="<%= discussion._id %>">
                            <%= discussion.content %>
                        </p>
                    </a>
                        <p class="discussion-time"><%= formattedTimestamp %></p>
                        <div class="discussion-toolbar">
                        <a class="reply-button discussion-btn" href="/discussion/<%= discussion._id %>"><%= replyCount %> Replies</a>
                            <button class="like-discussion-button discussion-btn" data-id="<%= discussion._id %>">
                                <i class="fa-solid fa-hands-clapping"></i>
                                <span class="count">
                                    <%= discussion.likes %>
                                </span>
                            </button>
                            <div class="flex-menu">
                                <% if (discussion.reported) { %>
                                    <p class="reported-status" data-tooltip="This Discussion was reported by a user and might contain sensitive input."><i class="fa fa-flag" aria-hidden="true"></i>
                                        Reported</p>
                                    <% } %>
                                <div class="dropdown">
                                    <a data-toggle="dropdown" class="dropbtn"><i class="fa fa-ellipsis-h"
                                            aria-hidden="true"></i></a>
                                    <!-- <span class="glyphicon glyphicon-option-vertical"> </span>-->
                                    <ul class="dropdown-content">
                                        <% if (user && user._id.toString()===discussion.user._id.toString()) { %>
                                            <li>
                                                <a href="#" class="delete-discussion-button discussion-btn"
                                                    data-id="<%= discussion._id %>">Delete</a>
                                            </li>
                                            <% } %>
                                                <li>
                                                    <a href="#" class="report-button"
                                                        onclick="reportContent('discussion', '<%= discussion._id %>')">Report</a>
                                                </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- hidden: replies on feed -->
                    <!-- <div class="reply-card">
                        <% discussion.replies.forEach(reply=> { %>
                            <div>
                                <p>
                                    <%= reply.user.username %>
                                </p>
                                <p>
                                    <%= reply.content %>
                                </p>
                                <button class="like-button discussion-btn" data-id="<%= reply._id %>">Like (<%= reply.likes %>
                                        )</button>
                                <button class="dislike-button discussion-btn" data-id="<%= reply._id %>">Dislike (<%= reply.dislikes %>
                                        )</button>
                            </div>
                            <% }); %>
                    </div> -->
                    <% }); %>
            </div>
        </div>
        <script>
            // dropdown for options on replies 
            const dropdownMenus = document.querySelectorAll('.dropbtn');
const dropdowns = document.querySelectorAll('.dropdown-content');

// Add a click event listener to each dropdown button
dropdownMenus.forEach((dropdownMenu, index) => {
 dropdownMenu.addEventListener('click', () => {
   // Toggle the display of the corresponding dropdown
   dropdowns[index].style.display = (dropdowns[index].style.display === 'block') ? 'none' : 'block';
 });
});

// Add a click event listener to the document to close the dropdowns when clicking outside
document.addEventListener('click', function (event) {
 dropdowns.forEach((dropdown, index) => {
   if (!dropdown.contains(event.target) && !dropdownMenus[index].contains(event.target)) {
     dropdown.style.display = 'none';
   }
 });
});
       </script>
        <script type="text/javascript" src="../assets/js/app.js"></script>
</body>

</html>