<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin-report.css">
    <link rel="stylesheet" href="../assets/css/sidebar.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/photos/brand/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../assets/photos/brand/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../assets/photos/brand/favicon-16x16.png">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&amp;display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/js/all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
   
    <title>Admin Support Page</title>
</head>
<body>
    <header>
        <div class="toggle">
            <i class="fas fa-bars"></i>
        </div>
        <h3>
            Messages
        </h3>
        <a href="/logout">
            <i class="fas fa-sign-out-alt"></i>
        </a>
    </header>
    <nav>
        <ul class="sidebar-menu-links">
            <li class="d-logo">
                <img src="../assets/photos/brand/favicon-32x32.png" alt="our logo">
            </li>
            <li>
                <a class="toggle">
                    <span class="icon"><i class="fas fa-bars"></i></span>
                    <span class="title">Menu</span>
                </a>
            </li>
            <li>
                <a href="/admin">
                    <span class="icon"><i class="fa fa-address-card" aria-hidden="true"></i></span>
                    <span class="title">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="/admin/reported-content">
                    <span class="icon"><i class="fa fa-flag" aria-hidden="true"></i>

                    </span>
                    <span class="title">Reported Content</span>
                </a>
            </li>
            <li>
                <a href="/logout">
                    <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span class="title">Sign Out</span>
                </a>
            </li>
        </ul>
    </nav>
    <section class="admin-support-container">
        <form>
            <label for="filter" hidden>Filter by:</label>
            <select id="filterSelect" class="classic">
                <option value="All">All</option>
                <option value="Contact">Contact</option>
                <option value="Feedback">Feedback</option>
                <option value="Complaint">Complaint</option>
            </select>
        </form>
    
        <div id="supportRequests" class="message-container">
            <!-- Support requests will be displayed here -->
        </div>
    </section>
    <script>
        const filterSelect = document.getElementById('filterSelect');
        const supportRequestsContainer = document.getElementById('supportRequests');
        // Function to fetch support requests from the server
        const fetchSupportRequestsFromServer = async () => {
            try {
                const response = await fetch('/admin/support');
                const data = await response.json();

                if (response.ok) {
                    return data.requests;
                } else {
                    console.error('Error fetching support requests');
                    return [];
                }
            } catch (error) {
                console.error(error);
                return [];
            }
        };

        // Function to delete a support request
        const deleteSupportRequest = async (requestId) => {
            try {
                const response = await fetch(`/admin/support/delete/${requestId}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    // Request was deleted successfully, update the UI
                    const deletedElement = document.getElementById(`support-request-${requestId}`);
                    if (deletedElement) {
                        deletedElement.remove();
                    }
                } else {
                    console.error('Error deleting support request');
                }
            } catch (error) {
                console.error(error);
            }
        };

        // Function to display support requests
        const displaySupportRequests = (requests) => {
            supportRequestsContainer.innerHTML = ''; // Clear previous requests
            requests.forEach(request => {
                const timestamp = request.createdAt;
                const date = new Date(timestamp);

const istOptions = {
  timeZone: 'Asia/Kolkata',
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  hour12: true, // Use 12-hour format
};
console.clear();
const formattedTimestamp = date.toLocaleString('en-IN', istOptions);
                const requestElement = document.createElement('div');
                requestElement.innerHTML = `<div class="chips-group"><span class="contact-type">${request.type}</span><span class="contact-time">${formattedTimestamp}</span><a href="mailto:${request.contactInfo}" target="_blank" data-tooltip="Send reply via mail"><i class="fa fa-reply" aria-hidden="true"></i></a></div><p class="request-message">${request.content}</p> `;
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteButton.addEventListener('click', () => {
                    deleteSupportRequest(request._id);
                });
                requestElement.appendChild(deleteButton);
                requestElement.id = `support-request-${request._id}`;
                requestElement.classList.add("request-card");
                supportRequestsContainer.appendChild(requestElement);
            });
        };

        // Function to filter and display support requests on the client side
        const filterAndDisplaySupportRequests = async (filter) => {
            const allSupportRequests = await fetchSupportRequestsFromServer();

            if (filter === 'All') {
                // Display all support requests
                displaySupportRequests(allSupportRequests);
            } else {
                // Filter support requests based on the selected filter
                const filteredRequests = allSupportRequests.filter(request => request.type === filter);
                displaySupportRequests(filteredRequests);
            }
        };

        // Listen for changes in the filter select element
        filterSelect.addEventListener('change', () => {
            const selectedFilter = filterSelect.value;
            filterAndDisplaySupportRequests(selectedFilter);
        });

        // Initially load all support requests
        filterAndDisplaySupportRequests('All');
    </script>
    <script src="../assets/js/script.js"></script>
</body>
</html>
